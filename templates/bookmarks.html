{% extends "base.html" %}

{% block title %}书签管理 - Homeman{% endblock %}

{% block extra_css %}
<style>
    .quick-add-input {
        width: 180px;
        transition: width 0.3s ease;
        font-size: 0.85rem;
        height: 32px;
    }
    
    .quick-add-input:focus {
        width: 250px;
    }
    
    .bookmark-checkbox {
        width: 16px;
        height: 16px;
        cursor: pointer;
        z-index: 10;
    }
    
    .bookmark-card {
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        overflow: hidden; /* 确保内容不会超出卡片边界 */
        height: 80px; /* 固定较小的高度 */
    }
    
    .bookmark-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .bookmark-actions {
        position: absolute;
        top: 4px;
        right: 4px;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 6;
    }
    
    .bookmark-card:hover .bookmark-actions {
        opacity: 1;
    }
    
    .bookmark-content {
        padding-right: 30px; /* 为右侧操作按钮留出空间 */
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .bookmark-content-with-checkbox {
        margin-left: 22px; /* 为多选框留出空间 */
    }
    
    .bookmark-title-area:hover {
        background-color: rgba(0,0,0,0.05);
        border-radius: 4px;
    }
    
    .bookmark-title-link:hover {
        color: #0d6efd !important;
    }
    
    .bookmark-url-link:hover {
        color: #6c757d !important;
    }
    
    .group-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .bookmark-icon-wrapper {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    /* 多选模式下的特殊样式 */
    .multi-select-mode .bookmark-actions {
        right: 4px; /* 保持原位置 */
    }
    
    /* 卡片内容布局优化 */
    .bookmark-card .card-body {
        padding: 6px; /* 减少内边距 */
    }
    
    .bookmark-content .d-flex {
        margin-bottom: 4px; /* 减少间距 */
    }
    
    .bookmark-content .mb-2:last-child {
        margin-bottom: 0; /* 移除最后元素的下边距 */
    }
    
    /* 可编辑分组标题样式 */
    .group-title-editable {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
        position: relative;
    }
    
    .group-title-editable:hover {
        background-color: rgba(0, 123, 255, 0.1);
        color: #0d6efd;
    }
    
    .group-title-editable:hover::after {
        content: " ✏️";
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .group-title-editing {
        background-color: rgba(255, 255, 255, 0.9);
        border: 2px solid #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .group-title-input {
        border: none;
        outline: none;
        background: transparent;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        width: 100%;
        padding: 0;
        margin: 0;
        height: auto;
        line-height: inherit;
        white-space: nowrap;
        overflow: hidden;
        resize: none;
    }
    
    /* 编辑状态时隐藏hover效果和铅笔图标 */
    .group-title-editing:hover::after {
        display: none;
    }
    
    .group-title-editing:hover {
        background-color: rgba(255, 255, 255, 0.9);
        color: inherit;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-2">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h1 class="h3 mb-0"><i class="fas fa-bookmark"></i> 书签管理</h1>
                <div class="btn-group">
                    <button type="button" class="btn btn-success btn-sm" onclick="showAddGroupModal()">
                        <i class="fas fa-plus"></i> 添加分组
                    </button>
                    <button type="button" class="btn btn-warning btn-sm" id="multiSelectBtn" onclick="toggleMultiSelect()">
                        <i class="fas fa-check-square"></i> 多选模式
                    </button>
                    <button type="button" class="btn btn-danger btn-sm d-none" id="deleteSelectedBtn" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> 删除选中
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-2">
                    <div id="bookmarks-container">
                        {% if bookmarks %}
                            {% for group in bookmarks %}
                                {% set group_name = group.keys() | first %}
                                {% set group_items = group[group_name] %}
                                <div class="bookmark-group mb-3" data-group="{{ group_name }}">
                                    <div class="group-header d-flex justify-content-between align-items-center mb-2 py-2 px-3">
                                        <div class="d-flex align-items-center flex-grow-1">
                                            <i class="fas fa-grip-vertical text-muted me-2 group-handle" style="cursor: grab;"></i>
                                            <h5 class="mb-0 me-3 group-title-editable" 
                                               data-group="{{ group_name }}" 
                                               onclick="startEditGroupName(this)"
                                               title="点击修改分组名称">{{ group_name }}</h5>
                                            
                                            <!-- 快速添加输入框 -->
                                            <div class="quick-add-container">
                                                <input type="text" 
                                                       class="form-control quick-add-input" 
                                                       placeholder="输入网址快速添加"
                                                       data-group="{{ group_name }}"
                                                       data-no-validate="true"
                                                       onkeypress="handleQuickAddKeypress(event, '{{ group_name }}')"
                                                       onblur="handleQuickAddBlur(event, '{{ group_name }}')"
                                                       onfocus="this.placeholder='粘贴网址后按回车添加'"
                                                       oninput="clearInputError(this)">
                                            </div>
                                        </div>
                                        
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="showAddBookmarkModal('{{ group_name }}')" title="详细添加">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup('{{ group_name }}')" title="删除分组">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="bookmark-items row g-2" data-group="{{ group_name }}">
                                        {% for item in group_items %}
                                            {% set bookmark_name = item.keys() | first %}
                                            {% set bookmark_config = item[bookmark_name] %}
                                            {% set bookmark_data = bookmark_config[0] if bookmark_config %}
                                            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                                                <div class="card bookmark-item bookmark-card h-100" data-bookmark="{{ bookmark_name }}" data-group="{{ group_name }}">
                                                    <div class="card-body p-2 position-relative">
                                                        <!-- 多选复选框 -->
                                                        <input type="checkbox" class="bookmark-checkbox position-absolute d-none" 
                                                               style="top: 4px; left: 4px;"
                                                               data-group="{{ group_name }}" data-bookmark="{{ bookmark_name }}">
                                                        
                                                        <!-- 操作按钮 -->
                                                        <div class="bookmark-actions">
                                                            <div class="btn-group-vertical">
                                                                <button class="btn btn-outline-warning" 
                                                                        onclick="editBookmark('{{ group_name }}', '{{ bookmark_name }}')" 
                                                                        title="编辑" 
                                                                        style="font-size: 0.7rem; padding: 2px 4px; line-height: 1.2; min-width: 22px; height: 22px;">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger" 
                                                                        onclick="deleteBookmark('{{ group_name }}', '{{ bookmark_name }}')" 
                                                                        title="删除" 
                                                                        style="font-size: 0.7rem; padding: 2px 4px; line-height: 1.2; min-width: 22px; height: 22px;">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- 书签内容 -->
                                                        <div class="bookmark-content">
                                                            <div class="d-flex align-items-center mb-2 bookmark-title-area" style="cursor: grab;">
                                                                <div class="bookmark-icon-wrapper me-2">
                                                                    {% if bookmark_data.icon %}
                                                                        <img src="{{ bookmark_data.icon }}" alt="{{ bookmark_name }}" 
                                                                             class="bookmark-icon" style="width: 16px; height: 16px; object-fit: cover;">
                                                                    {% elif bookmark_data.abbr %}
                                                                        <span class="badge bg-primary" style="font-size: 0.6rem; padding: 2px 4px;">{{ bookmark_data.abbr }}</span>
                                                                    {% else %}
                                                                        <i class="fas fa-globe text-muted" style="font-size: 0.8rem;"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <a href="{{ bookmark_data.href }}" target="_blank" 
                                                                   class="text-decoration-none text-dark text-truncate bookmark-title-link" 
                                                                   style="font-size: 0.85rem; line-height: 1.2; font-weight: bold;" 
                                                                   title="{{ bookmark_name }} - 点击打开链接">{{ bookmark_name }}</a>
                                                            </div>
                                                            
                                                            <div class="mb-2">
                                                                <a href="{{ bookmark_data.href }}" target="_blank" 
                                                                   class="text-muted text-decoration-none bookmark-url-link"
                                                                   style="font-size: 0.75rem; line-height: 1.3;" 
                                                                   title="点击打开: {{ bookmark_data.description or bookmark_data.href }}">
                                                                    <small class="text-truncate d-block">{{ bookmark_data.description or bookmark_data.href }}</small>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                <h4>还没有书签</h4>
                                <p class="text-muted">点击"添加分组"开始创建您的第一个书签分组</p>
                                <button class="btn btn-primary" onclick="showAddGroupModal()">
                                    <i class="fas fa-plus"></i> 添加分组
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑分组模态框 -->
<div class="modal fade" id="groupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupModalTitle">添加分组</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="groupForm" onsubmit="return saveGroup(event)">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">分组名称</label>
                        <input type="text" class="form-control" id="groupName" required autocomplete="off">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="groupForm" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑书签模态框 -->
<div class="modal fade" id="bookmarkModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookmarkModalTitle">添加书签</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookmarkForm" onsubmit="return saveBookmark(event)">
                    <input type="hidden" id="bookmarkGroup">
                    <input type="hidden" id="originalBookmarkName">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookmarkName" class="form-label">书签名称</label>
                                <input type="text" class="form-control" id="bookmarkName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookmarkHref" class="form-label">链接地址</label>
                                <input type="url" class="form-control" id="bookmarkHref" required onblur="autoFillBookmarkInfo()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookmarkIcon" class="form-label">图标</label>
                                <input type="text" class="form-control" id="bookmarkIcon" placeholder="example.png 或 mdi-github">
                                <div class="form-text">支持文件名、MDI 图标、Simple Icons 或图标 URL</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookmarkAbbr" class="form-label">缩写</label>
                                <input type="text" class="form-control" id="bookmarkAbbr" maxlength="2" placeholder="GH">
                                <div class="form-text">如果没有图标，显示 2 个字符的缩写</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bookmarkDescription" class="form-label">描述</label>
                        <input type="text" class="form-control" id="bookmarkDescription" placeholder="可选，默认使用链接的域名">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="bookmarkForm" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    let bookmarksData = {{ bookmarks | tojson | safe }} || [];
    let currentEditingGroup = null;
    let currentEditingBookmark = null;
    let isMultiSelectMode = false;
    let groupSortable = null;
    let bookmarkSortables = [];

    // 初始化拖拽功能
    document.addEventListener('DOMContentLoaded', function() {
        initializeDragAndDrop();
    });

    function initializeDragAndDrop() {
        // 销毁现有的sortable实例
        if (groupSortable) {
            groupSortable.destroy();
        }
        bookmarkSortables.forEach(sortable => sortable.destroy());
        bookmarkSortables = [];

        // 分组拖拽排序
        const container = document.getElementById('bookmarks-container');
        if (container) {
            groupSortable = Sortable.create(container, {
                handle: '.group-handle',
                animation: 150,
                onEnd: function(evt) {
                    const item = bookmarksData.splice(evt.oldIndex, 1)[0];
                    bookmarksData.splice(evt.newIndex, 0, item);
                    saveBookmarks();
                }
            });
        }

        // 书签拖拽排序和移动
        document.querySelectorAll('.bookmark-items').forEach(container => {
            const sortable = Sortable.create(container, {
                group: 'bookmarks',
                handle: '.bookmark-title-area',
                animation: 150,
                onEnd: function(evt) {
                    const oldGroupName = evt.from.dataset.group;
                    const newGroupName = evt.to.dataset.group;
                    
                    const oldGroupIndex = bookmarksData.findIndex(g => Object.keys(g)[0] === oldGroupName);
                    const newGroupIndex = bookmarksData.findIndex(g => Object.keys(g)[0] === newGroupName);
                    
                    if (oldGroupIndex !== -1 && newGroupIndex !== -1) {
                        const bookmark = bookmarksData[oldGroupIndex][oldGroupName].splice(evt.oldIndex, 1)[0];
                        bookmarksData[newGroupIndex][newGroupName].splice(evt.newIndex, 0, bookmark);
                        saveBookmarks();
                    }
                }
            });
            bookmarkSortables.push(sortable);
        });
    }

    // 自动补充协议前缀
    function normalizeUrl(url) {
        if (!url) return url;
        
        url = url.trim();
        
        // 如果已经有协议，直接返回
        if (/^https?:\/\//i.test(url)) {
            return url;
        }
        
        // 如果是本地地址或IP，使用http
        if (/^(localhost|127\.0\.0\.1|\d+\.\d+\.\d+\.\d+)/i.test(url)) {
            return 'http://' + url;
        }
        
        // 其他情况使用http（更好的兼容性）
        return 'http://' + url;
    }

    // 严格验证Web URL
    function isValidWebUrl(url) {
        try {
            const urlObj = new URL(url);
            
            // 必须是http或https协议
            if (!['http:', 'https:'].includes(urlObj.protocol)) {
                return false;
            }
            
            // 必须有hostname
            if (!urlObj.hostname) {
                return false;
            }
            
            // 检查是否是有效的域名或IP
            const hostname = urlObj.hostname;
            
            // 本地地址总是有效
            if (['localhost', '127.0.0.1'].includes(hostname)) {
                return true;
            }
            
            // IP地址格式检查
            const ipRegex = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
            if (ipRegex.test(hostname)) {
                const parts = hostname.split('.');
                return parts.every(part => {
                    const num = parseInt(part, 10);
                    return num >= 0 && num <= 255;
                });
            }
            
            // 域名格式检查
            const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            if (!domainRegex.test(hostname)) {
                return false;
            }
            
            // 必须有顶级域名（除非是IP或localhost）
            if (!hostname.includes('.') && !['localhost'].includes(hostname) && !ipRegex.test(hostname)) {
                return false;
            }
            
            return true;
        } catch (e) {
            return false;
        }
    }

    // 简化的网站信息提取函数
    function extractSiteInfo(url) {
        try {
            const normalizedUrl = normalizeUrl(url);
            const urlObj = new URL(normalizedUrl);
            const hostname = urlObj.hostname;
            
            // 去掉 www. 前缀
            const domain = hostname.replace(/^www\./, '');
            
            // 获取主域名（去掉子域名）
            const parts = domain.split('.');
            let siteName = parts[0];
            
            // 常见网站的特殊处理
            const siteNameMap = {
                'github': 'GitHub',
                'gitlab': 'GitLab',
                'stackoverflow': 'Stack Overflow',
                'youtube': 'YouTube',
                'google': 'Google',
                'microsoft': 'Microsoft',
                'apple': 'Apple',
                'amazon': 'Amazon',
                'reddit': 'Reddit',
                'twitter': 'Twitter',
                'facebook': 'Facebook',
                'linkedin': 'LinkedIn',
                'instagram': 'Instagram',
                'medium': 'Medium',
                'netflix': 'Netflix',
                'spotify': 'Spotify'
            };
            
            // 使用映射表或首字母大写
            const displayName = siteNameMap[siteName.toLowerCase()] || 
                               siteName.charAt(0).toUpperCase() + siteName.slice(1);
            
            // 生成缩写
            let abbr = '';
            if (displayName.includes(' ')) {
                // 多个单词：取每个单词的首字母
                abbr = displayName.split(' ')
                    .map(word => word.charAt(0))
                    .join('')
                    .substring(0, 2)
                    .toUpperCase();
            } else {
                // 单个单词：取前两个字符
                abbr = displayName.substring(0, 2).toUpperCase();
            }
            
            return {
                name: displayName,
                abbr: abbr,
                domain: domain,
                normalizedUrl: normalizedUrl
            };
        } catch (e) {
            console.warn('URL 解析失败:', e);
            return {
                name: '',
                abbr: '',
                domain: '',
                normalizedUrl: normalizeUrl(url)
            };
        }
    }

    // 设置输入框错误状态（只显示红色边框，不显示下方文字）
    function setInputError(input) {
        // 添加Bootstrap验证错误样式（红色边框）
        input.classList.add('is-invalid');
        
        // 移除可能已存在的错误文字消息
        const errorDiv = input.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.remove();
        }
    }

    // 清除输入框错误状态
    function clearInputError(input) {
        // 移除Bootstrap验证错误样式
        input.classList.remove('is-invalid');
        
        // 移除错误消息
        const errorDiv = input.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.remove();
        }
        
        // 如果validator实例存在，也调用它的清除方法
        if (window.validator && typeof window.validator.clearFieldError === 'function') {
            window.validator.clearFieldError(input);
        }
    }

    // 快速添加功能
    function handleQuickAddKeypress(event, groupName) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const input = event.target;
            const url = input.value.trim();
            
            if (!url) {
                showError('请输入网址');
                setInputError(input);
                input.focus(); // 保持焦点，方便用户输入
                return;
            }

            // 自动补充协议并验证URL
            const normalizedUrl = normalizeUrl(url);
            if (!isValidWebUrl(normalizedUrl)) {
                showError('请输入有效的网址');
                setInputError(input);
                input.focus(); // 保持焦点，保留输入内容让用户修改
                return;
            }

            // 提取网站信息
            const siteInfo = extractSiteInfo(url);
            const name = siteInfo.name || 'New Bookmark';
            const abbr = siteInfo.abbr || '';

            // 构建书签数据
            const bookmarkData = { href: siteInfo.normalizedUrl };
            if (abbr) bookmarkData.abbr = abbr;

            // 找到分组并添加书签
            const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === groupName);
            if (groupIndex !== -1) {
                bookmarksData[groupIndex][groupName].push({ [name]: [bookmarkData] });
                
                // 显示成功消息
                showSuccess(`已添加书签 "${name}" 到分组 "${groupName}"`);
                
                // 清除输入框的错误状态
                clearInputError(input);
                
                // 清空输入框（只在成功时清空）
                input.value = '';
                input.blur();
                
                // 保存数据，但避免页面刷新导致状态丢失
                saveBookmarksWithoutReload(groupName, name, bookmarkData);
            } else {
                showError('分组不存在');
                setInputError(input);
                input.focus(); // 保持焦点
            }
        }
    }

    function handleQuickAddBlur(event, groupName) {
        // 失去焦点时恢复默认提示文字
        event.target.placeholder = '输入网址快速添加';
    }

    function showAddGroupModal() {
        currentEditingGroup = null;
        document.getElementById('groupModalTitle').textContent = '添加分组';
        document.getElementById('groupName').value = '';
        new bootstrap.Modal(document.getElementById('groupModal')).show();
        setTimeout(() => document.getElementById('groupName').focus(), 100);
    }

    function editGroup(groupName) {
        currentEditingGroup = groupName;
        document.getElementById('groupModalTitle').textContent = '编辑分组';
        document.getElementById('groupName').value = groupName;
        new bootstrap.Modal(document.getElementById('groupModal')).show();
        setTimeout(() => document.getElementById('groupName').focus(), 100);
    }

    // 新增：直接编辑分组名称功能
    function startEditGroupName(element) {
        const currentName = element.textContent.trim();
        const originalName = element.dataset.group;
        
        // 防止重复编辑
        if (element.querySelector('.group-title-input')) {
            return;
        }
        
        // 创建输入框
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentName;
        input.className = 'group-title-input';
        input.setAttribute('data-original-name', originalName);
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('spellcheck', 'false');
        
        // 防止换行和多行
        input.style.minHeight = 'auto';
        input.style.maxHeight = 'none';
        input.style.height = 'auto';
        input.style.display = 'inline-block';
        
        // 添加编辑状态样式
        element.classList.add('group-title-editing');
        
        // 清空元素内容并添加输入框
        element.textContent = '';
        element.appendChild(input);
        
        // 选中输入框文本
        input.focus();
        input.select();
        
        // 添加取消标志
        let isCancelled = false;
        
        // 绑定事件
        input.addEventListener('blur', () => {
            if (!isCancelled) {
                finishEditGroupName(element, input);
            }
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishEditGroupName(element, input);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                isCancelled = true;
                cancelEditGroupName(element, input, originalName);
            }
        });
        
        // 防止输入框出现多行或换行行为
        input.addEventListener('input', (e) => {
            // 移除任何换行符
            input.value = input.value.replace(/\n/g, '');
        });
        
        input.addEventListener('paste', (e) => {
            // 处理粘贴内容，移除换行符
            setTimeout(() => {
                input.value = input.value.replace(/\n/g, '');
            }, 0);
        });
        
        // 阻止事件冒泡，防止触发其他点击事件
        input.addEventListener('click', (e) => e.stopPropagation());
    }
    
    function finishEditGroupName(element, input) {
        const newName = input.value.trim();
        const originalName = input.getAttribute('data-original-name');
        
        if (!newName) {
            showError('分组名称不能为空');
            input.focus();
            return;
        }
        
        // 检查是否有重名分组
        const existingGroup = bookmarksData.find(group => {
            const groupName = Object.keys(group)[0];
            return groupName === newName && groupName !== originalName;
        });
        
        if (existingGroup) {
            showError('分组名称已存在');
            input.focus();
            return;
        }
        
        // 如果名称没有变化，直接取消编辑
        if (newName === originalName) {
            cancelEditGroupName(element, input, originalName);
            return;
        }
        
        // 更新数据
        const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === originalName);
        if (groupIndex !== -1) {
            const groupItems = bookmarksData[groupIndex][originalName];
            bookmarksData[groupIndex] = { [newName]: groupItems };
            
            // 更新UI
            element.classList.remove('group-title-editing');
            element.textContent = newName;
            element.dataset.group = newName;
            
            // 更新相关的data-group属性
            updateGroupReferences(originalName, newName);
            
            // 保存到服务器
            saveBookmarks();
            
            showSuccess(`分组名称已更改为"${newName}"`);
        } else {
            showError('分组不存在');
            cancelEditGroupName(element, input, originalName);
        }
    }
    
    function cancelEditGroupName(element, input, originalName) {
        element.classList.remove('group-title-editing');
        element.textContent = originalName;
    }
    
    function updateGroupReferences(oldName, newName) {
        // 更新bookmark-group容器的data-group
        const groupContainer = document.querySelector(`[data-group="${oldName}"]`);
        if (groupContainer) {
            groupContainer.dataset.group = newName;
        }
        
        // 更新bookmark-items容器的data-group
        const itemsContainer = document.querySelector(`.bookmark-items[data-group="${oldName}"]`);
        if (itemsContainer) {
            itemsContainer.dataset.group = newName;
        }
        
        // 更新快速添加输入框的data-group
        const quickAddInput = document.querySelector(`input[data-group="${oldName}"]`);
        if (quickAddInput) {
            quickAddInput.dataset.group = newName;
            quickAddInput.setAttribute('onkeypress', `handleQuickAddKeypress(event, '${newName}')`);
            quickAddInput.setAttribute('onblur', `handleQuickAddBlur(event, '${newName}')`);
        }
        
        // 更新书签卡片的data-group
        const bookmarkCards = document.querySelectorAll(`[data-group="${oldName}"]`);
        bookmarkCards.forEach(card => {
            card.dataset.group = newName;
        });
        
        // 更新按钮的onclick属性
        const addBookmarkBtn = document.querySelector(`button[onclick="showAddBookmarkModal('${oldName}')"]`);
        if (addBookmarkBtn) {
            addBookmarkBtn.setAttribute('onclick', `showAddBookmarkModal('${newName}')`);
        }
        
        const deleteGroupBtn = document.querySelector(`button[onclick="deleteGroup('${oldName}')"]`);
        if (deleteGroupBtn) {
            deleteGroupBtn.setAttribute('onclick', `deleteGroup('${newName}')`);
        }
    }

    function saveGroup(event) {
        if (event) {
            event.preventDefault();
        }
        
        const groupName = document.getElementById('groupName').value.trim();
        if (!groupName) {
            showError('请输入分组名称');
            return false;
        }

        if (currentEditingGroup) {
            const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === currentEditingGroup);
            if (groupIndex !== -1) {
                const items = bookmarksData[groupIndex][currentEditingGroup];
                bookmarksData[groupIndex] = { [groupName]: items };
            }
        } else {
            bookmarksData.push({ [groupName]: [] });
        }

        saveBookmarks();
        var modal = bootstrap.Modal.getInstance(document.getElementById('groupModal'));
        modal.hide();
        return false;
    }

    function deleteGroup(groupName) {
        if (confirm(`确定要删除分组"${groupName}"吗？该操作将删除分组内的所有书签。`)) {
            bookmarksData = bookmarksData.filter(group => Object.keys(group)[0] !== groupName);
            saveBookmarks();
        }
    }

    function showAddBookmarkModal(groupName) {
        currentEditingGroup = groupName;
        currentEditingBookmark = null;
        document.getElementById('bookmarkModalTitle').textContent = '添加书签';
        document.getElementById('bookmarkGroup').value = groupName;
        document.getElementById('originalBookmarkName').value = '';
        
        // 清空表单
        document.getElementById('bookmarkName').value = '';
        document.getElementById('bookmarkHref').value = '';
        document.getElementById('bookmarkIcon').value = '';
        document.getElementById('bookmarkAbbr').value = '';
        document.getElementById('bookmarkDescription').value = '';
        
        new bootstrap.Modal(document.getElementById('bookmarkModal')).show();
        setTimeout(() => document.getElementById('bookmarkName').focus(), 100);
    }

    function autoFillBookmarkInfo() {
        const href = document.getElementById('bookmarkHref').value.trim();
        const nameField = document.getElementById('bookmarkName');
        const abbrField = document.getElementById('bookmarkAbbr');
        
        if (href && !nameField.value) {
            // 自动补充协议
            const normalizedUrl = normalizeUrl(href);
            document.getElementById('bookmarkHref').value = normalizedUrl;
            
            const siteInfo = extractSiteInfo(href);
            if (siteInfo.name) {
                nameField.value = siteInfo.name;
                if (!abbrField.value) {
                    abbrField.value = siteInfo.abbr;
                }
            }
        }
    }

    function editBookmark(groupName, bookmarkName) {
        currentEditingGroup = groupName;
        currentEditingBookmark = bookmarkName;
        
        const group = bookmarksData.find(g => Object.keys(g)[0] === groupName);
        const bookmark = group[groupName].find(b => Object.keys(b)[0] === bookmarkName);
        const bookmarkConfig = bookmark[bookmarkName];
        const bookmarkData = bookmarkConfig && bookmarkConfig.length > 0 ? bookmarkConfig[0] : {};
        
        document.getElementById('bookmarkModalTitle').textContent = '编辑书签';
        document.getElementById('bookmarkGroup').value = groupName;
        document.getElementById('originalBookmarkName').value = bookmarkName;
        
        document.getElementById('bookmarkName').value = bookmarkName;
        document.getElementById('bookmarkHref').value = bookmarkData.href || '';
        document.getElementById('bookmarkIcon').value = bookmarkData.icon || '';
        document.getElementById('bookmarkAbbr').value = bookmarkData.abbr || '';
        document.getElementById('bookmarkDescription').value = bookmarkData.description || '';
        
        new bootstrap.Modal(document.getElementById('bookmarkModal')).show();
        setTimeout(() => document.getElementById('bookmarkName').focus(), 100);
    }

    function saveBookmark(event) {
        if (event) {
            event.preventDefault();
        }

        const groupName = document.getElementById('bookmarkGroup').value;
        const originalName = document.getElementById('originalBookmarkName').value;
        const name = document.getElementById('bookmarkName').value.trim();
        let href = document.getElementById('bookmarkHref').value.trim();
        const icon = document.getElementById('bookmarkIcon').value.trim();
        const abbr = document.getElementById('bookmarkAbbr').value.trim();
        const description = document.getElementById('bookmarkDescription').value.trim();

        if (!name || !href) {
            showError('请填写书签名称和链接地址');
            return false;
        }

        // 自动补充协议
        href = normalizeUrl(href);

        try {
            new URL(href);
        } catch (e) {
            showError('请输入有效的 URL 地址');
            return false;
        }

        const bookmarkData = { href };
        if (icon) bookmarkData.icon = icon;
        if (abbr) bookmarkData.abbr = abbr;
        if (description) bookmarkData.description = description;

        const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === groupName);
        if (groupIndex === -1) {
            showError('分组不存在');
            return false;
        }

        if (currentEditingBookmark) {
            const bookmarkIndex = bookmarksData[groupIndex][groupName].findIndex(b => Object.keys(b)[0] === originalName);
            if (bookmarkIndex !== -1) {
                bookmarksData[groupIndex][groupName][bookmarkIndex] = { [name]: [bookmarkData] };
            }
        } else {
            bookmarksData[groupIndex][groupName].push({ [name]: [bookmarkData] });
        }

        saveBookmarks();
        var modal = bootstrap.Modal.getInstance(document.getElementById('bookmarkModal'));
        modal.hide();
        return false;
    }

    function deleteBookmark(groupName, bookmarkName) {
        if (confirm(`确定要删除书签"${bookmarkName}"吗？`)) {
            const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === groupName);
            if (groupIndex !== -1) {
                bookmarksData[groupIndex][groupName] = bookmarksData[groupIndex][groupName].filter(b => Object.keys(b)[0] !== bookmarkName);
                saveBookmarks();
            }
        }
    }

    function toggleMultiSelect() {
        isMultiSelectMode = !isMultiSelectMode;
        const checkboxes = document.querySelectorAll('.bookmark-checkbox');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const bookmarkContainer = document.getElementById('bookmarks-container');
        
        if (isMultiSelectMode) {
            checkboxes.forEach(cb => cb.classList.remove('d-none'));
            // 为书签内容添加左边距
            document.querySelectorAll('.bookmark-content').forEach(content => {
                content.classList.add('bookmark-content-with-checkbox');
            });
            bookmarkContainer.classList.add('multi-select-mode');
            multiSelectBtn.innerHTML = '<i class="fas fa-times"></i> 退出多选';
            multiSelectBtn.classList.remove('btn-warning');
            multiSelectBtn.classList.add('btn-secondary');
            deleteSelectedBtn.classList.remove('d-none');
        } else {
            checkboxes.forEach(cb => {
                cb.classList.add('d-none');
                cb.checked = false;
            });
            // 移除书签内容的左边距
            document.querySelectorAll('.bookmark-content').forEach(content => {
                content.classList.remove('bookmark-content-with-checkbox');
            });
            bookmarkContainer.classList.remove('multi-select-mode');
            multiSelectBtn.innerHTML = '<i class="fas fa-check-square"></i> 多选模式';
            multiSelectBtn.classList.remove('btn-secondary');
            multiSelectBtn.classList.add('btn-warning');
            deleteSelectedBtn.classList.add('d-none');
        }
    }

    function deleteSelected() {
        const selectedCheckboxes = document.querySelectorAll('.bookmark-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showError('请选择要删除的书签');
            return;
        }

        if (confirm(`确定要删除选中的 ${selectedCheckboxes.length} 个书签吗？`)) {
            selectedCheckboxes.forEach(checkbox => {
                const groupName = checkbox.dataset.group;
                const bookmarkName = checkbox.dataset.bookmark;
                
                const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === groupName);
                if (groupIndex !== -1) {
                    bookmarksData[groupIndex][groupName] = bookmarksData[groupIndex][groupName].filter(b => Object.keys(b)[0] !== bookmarkName);
                }
            });
            
            saveBookmarks();
            toggleMultiSelect();
        }
    }

    function saveBookmarks() {
        fetch('/bookmarks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookmarksData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                showError('保存失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('保存失败: ' + error.message);
        });
    }

    // 保存书签但不刷新页面（用于快速添加）
    function saveBookmarksWithoutReload(groupName, bookmarkName, bookmarkData) {
        fetch('/bookmarks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookmarksData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 成功保存，动态添加DOM元素而不是刷新页面
                addBookmarkToDOM(groupName, bookmarkName, bookmarkData);
                // 重新初始化拖拽功能
                initializeDragAndDrop();
            } else {
                showError('保存失败: ' + data.message);
                // 保存失败，回滚数据
                const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === groupName);
                if (groupIndex !== -1) {
                    bookmarksData[groupIndex][groupName] = bookmarksData[groupIndex][groupName].filter(b => Object.keys(b)[0] !== bookmarkName);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('保存失败: ' + error.message);
            // 保存失败，回滚数据
            const groupIndex = bookmarksData.findIndex(group => Object.keys(group)[0] === groupName);
            if (groupIndex !== -1) {
                bookmarksData[groupIndex][groupName] = bookmarksData[groupIndex][groupName].filter(b => Object.keys(b)[0] !== bookmarkName);
            }
        });
    }

    // 动态添加书签到DOM
    function addBookmarkToDOM(groupName, bookmarkName, bookmarkData) {
        const groupContainer = document.querySelector(`[data-group="${groupName}"] .bookmark-items`);
        if (!groupContainer) return;

        const newBookmarkHtml = `
            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                <div class="card bookmark-item bookmark-card h-100" data-bookmark="${bookmarkName}" data-group="${groupName}">
                    <div class="card-body p-2 position-relative">
                        <!-- 多选复选框 -->
                        <input type="checkbox" class="bookmark-checkbox position-absolute d-none" 
                               style="top: 4px; left: 4px;"
                               data-group="${groupName}" data-bookmark="${bookmarkName}">
                        
                        <!-- 操作按钮 -->
                        <div class="bookmark-actions">
                            <div class="btn-group-vertical">
                                <button class="btn btn-outline-warning" 
                                        onclick="editBookmark('${groupName}', '${bookmarkName}')" 
                                        title="编辑" 
                                        style="font-size: 0.7rem; padding: 2px 4px; line-height: 1.2; min-width: 22px; height: 22px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" 
                                        onclick="deleteBookmark('${groupName}', '${bookmarkName}')" 
                                        title="删除" 
                                        style="font-size: 0.7rem; padding: 2px 4px; line-height: 1.2; min-width: 22px; height: 22px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 书签内容 -->
                        <div class="bookmark-content">
                            <div class="d-flex align-items-center mb-2 bookmark-title-area" style="cursor: grab;">
                                <div class="bookmark-icon-wrapper me-2">
                                    ${bookmarkData.icon ? 
                                        `<img src="${bookmarkData.icon}" alt="${bookmarkName}" class="bookmark-icon" style="width: 16px; height: 16px; object-fit: cover;">` :
                                        bookmarkData.abbr ? 
                                            `<span class="badge bg-primary" style="font-size: 0.6rem; padding: 2px 4px;">${bookmarkData.abbr}</span>` :
                                            `<i class="fas fa-globe text-muted" style="font-size: 0.8rem;"></i>`
                                    }
                                </div>
                                <a href="${bookmarkData.href}" target="_blank" 
                                   class="text-decoration-none text-dark text-truncate bookmark-title-link" 
                                   style="font-size: 0.85rem; line-height: 1.2; font-weight: bold;" 
                                   title="${bookmarkName} - 点击打开链接">${bookmarkName}</a>
                            </div>
                            
                            <div class="mb-2">
                                <a href="${bookmarkData.href}" target="_blank" 
                                   class="text-muted text-decoration-none bookmark-url-link"
                                   style="font-size: 0.75rem; line-height: 1.3;" 
                                   title="点击打开: ${bookmarkData.description || bookmarkData.href}">
                                    <small class="text-truncate d-block">${bookmarkData.description || bookmarkData.href}</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        groupContainer.insertAdjacentHTML('beforeend', newBookmarkHtml);
    }

    // 简单的提示函数
    function showSuccess(message) {
        // 使用Validator实例的方法
        if (window.validator && typeof window.validator.showSuccess === 'function') {
            window.validator.showSuccess(message);
        } else {
            // 创建Bootstrap Toast
            createToast(message, 'success');
        }
    }

    function showError(message) {
        // 使用Validator实例的方法
        if (window.validator && typeof window.validator.showError === 'function') {
            window.validator.showError(message);
        } else {
            // 创建Bootstrap Toast
            createToast(message, 'danger');
        }
    }

    function createToast(message, type) {
        // 创建 toast 容器（如果不存在）
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }

        // 创建 toast
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${escapeHtml(message)}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        toastContainer.appendChild(toast);

        // 显示 toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: type === 'success' ? 3000 : 5000
        });
        bsToast.show();

        // 自动移除
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %} 